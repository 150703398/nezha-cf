#!/usr/bin/env bash
set -e

# =========================
# ğŸŸ¢ é…ç½®å‚æ•°
# =========================
INSTALL_DIR="/opt/nezha-cf-tunnel"
DASHBOARD_IMAGE="ghcr.io/nezhahq/nezha:v1.14.14"
CLOUDFLARE_IMAGE="cloudflare/cloudflared:latest"
ARGO_TOKEN=""   # <-- å¡«å…¥ä½ çš„ ARGO TUNNEL TOKEN
HOSTNAME="ä½ çš„TUNNELåŸŸå"
HOST_PORT=5555      # VPS å…¬ç½‘ç«¯å£æ˜ å°„åˆ° Dashboard å†…éƒ¨ç«¯å£
SECRET_LENGTH=32

# =========================
# ğŸ“‚ åˆå§‹åŒ–ç›®å½•
# =========================
mkdir -p "$INSTALL_DIR"/{data,cert,backup}
cd "$INSTALL_DIR"

# =========================
# ğŸ”‘ ç”Ÿæˆæˆ–è¯»å– Dashboard secret
if [[ -f "$INSTALL_DIR/secret.txt" ]]; then
    NZ_CLIENT_SECRET=$(cat "$INSTALL_DIR/secret.txt")
    echo "âœ… è¯»å–ç°æœ‰ NZ_CLIENT_SECRET: $NZ_CLIENT_SECRET"
else
    NZ_CLIENT_SECRET=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c $SECRET_LENGTH)
    echo "$NZ_CLIENT_SECRET" > "$INSTALL_DIR/secret.txt"
    echo "âœ… ç”Ÿæˆæ–°çš„ NZ_CLIENT_SECRET: $NZ_CLIENT_SECRET"
fi

# =========================
# ğŸ³ æ¸…ç†æ—§å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker rm -f nezha-dashboard nezha-cloudflared >/dev/null 2>&1 || true

# =========================
# ğŸ“¦ æ£€æŸ¥åŒ¿å volume å¹¶è¿ç§»
ANON_VOLUME=$(docker volume ls -q | xargs -I{} docker inspect {} --format '{{.Mountpoint}}' | grep nezha || true)
if [[ -n "$ANON_VOLUME" ]]; then
    echo "â¡ï¸ å‘ç°åŒ¿å volumeï¼Œè¿ç§»æ•°æ®åˆ° $INSTALL_DIR/data"
    cp -a "$ANON_VOLUME"/. "$INSTALL_DIR/data"/ || true
fi

# =========================
# ğŸ“„ åˆ›å»º docker-compose.yml
cat > docker-compose.yml <<EOF
version: '3.9'
services:
  nezha-dashboard:
    image: $DASHBOARD_IMAGE
    container_name: nezha-dashboard
    restart: unless-stopped
    environment:
      - NZ_DB_PATH=/dashboard/data/nezha.db
      - NZ_CLIENT_SECRET=$NZ_CLIENT_SECRET
      - NZ_LISTEN_PORT=8008
    ports:
      - "$HOST_PORT:8008"
    volumes:
      - ./data:/dashboard/data

  nezha-cloudflared:
    image: $CLOUDFLARE_IMAGE
    container_name: nezha-cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token "$ARGO_TOKEN"
    depends_on:
      - nezha-dashboard
EOF

# =========================
# ğŸš€ å¯åŠ¨æœåŠ¡
docker-compose up -d

# =========================
# ğŸ” è‡ªæ£€ Dashboard å†…éƒ¨è®¿é—®
sleep 5
DASHBOARD_OK="no"
if docker exec nezha-dashboard sh -c "apk add --no-cache wget >/dev/null 2>&1 || true; wget -qO- http://127.0.0.1:8008/ | grep -q 'Nezha'" ; then
    DASHBOARD_OK="yes"
fi

# =========================
# ğŸ“„ è¾“å‡ºä¿¡æ¯
echo "=============================="
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ Dashboard è®¿é—®åœ°å€ (Cloudflare Tunnel): https://$HOSTNAME"
echo "ğŸ”’ Dashboard å†…éƒ¨ç«¯å£ (VPS Agent å¯è®¿é—®): $HOST_PORT"
echo "ğŸ›¡ï¸ NZ_CLIENT_SECRET: $NZ_CLIENT_SECRET"
echo "ğŸ“Œ Dashboard å†…éƒ¨çŠ¶æ€è‡ªæ£€: $DASHBOARD_OK"
echo "=============================="
echo "ğŸ“Œ VPS Agent ä½¿ç”¨ç¤ºä¾‹:"
echo "export NZ_SERVER=http://<VPS_IP>:$HOST_PORT"
echo "export NZ_CLIENT_SECRET=$NZ_CLIENT_SECRET"
echo "nohup ./nezha-agent_linux_amd64 &"
echo "=============================="
